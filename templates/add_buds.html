<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cannabis App - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏≠‡∏Å</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5em;
            font-weight: 300;
        }

        .back-btn {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .form-content {
            padding: 40px;
        }

        .form-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 30px;
            border-left: 5px solid #4CAF50;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: 600;
            color: #2c5530;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
        }

        .form-group.full-width {
            flex: 100%;
        }

        .form-group.half-width {
            flex: 1;
            min-width: 200px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
            box-sizing: border-box;
        }

        input[type="file"] {
            padding: 8px;
            background: #f8f9fa;
            border: 2px dashed #e9ecef;
        }

        input[type="file"]:hover {
            border-color: #4CAF50;
            background: #f0f8f0;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4CAF50;
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .required {
            color: #dc3545;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            text-decoration: none;
            display: inline-block;
            text-align: center;
            transition: all 0.3s ease;
            margin: 10px 5px;
        }

        .btn-primary {
            background: #4CAF50;
            color: white;
        }

        .btn-primary:hover {
            background: #45a049;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .form-actions {
            text-align: center;
            margin-top: 30px;
            padding-top: 30px;
            border-top: 1px solid #e9ecef;
        }

        .alert {
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 8px;
            font-weight: 500;
        }

        .alert-success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .help-text {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
            font-style: italic;
        }

        .loading-dropdown {
            color: #6c757d;
            font-style: italic;
        }

        /* Autocomplete Styles */
        .autocomplete-container {
            position: relative;
        }

        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 2px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .suggestion-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            transition: background-color 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item.selected {
            background-color: #4CAF50;
            color: white;
        }

        .suggestion-main {
            font-weight: 500;
        }

        .suggestion-meta {
            font-size: 12px;
            color: #6c757d;
            display: flex;
            gap: 8px;
        }

        .suggestion-item.selected .suggestion-meta {
            color: rgba(255, 255, 255, 0.8);
        }

        .popular-badge {
            background: #ffc107;
            color: #212529;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
        }

        .strain-type-badge {
            background: #6f42c1;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
        }

        .no-suggestions {
            padding: 12px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
            }

            .form-group {
                min-width: auto;
            }

            .container {
                margin: 10px;
            }

            .form-content {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/profile" class="back-btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
            <h1>üåø ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏≠‡∏Å</h1>
            <div class="subtitle">‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ç‡∏≠‡∏á‡∏î‡∏≠‡∏Å‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ</div>
        </div>

        <div class="form-content">
            <div id="alertContainer"></div>

            <form id="budsForm">
                <!-- Basic Information -->
                <div class="form-section">
                    <div class="section-title">
                        üìã ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="strain_name_en">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©) <span class="required">*</span></label>
                            <div class="autocomplete-container">
                                <input type="text" id="strain_name_en" name="strain_name_en" 
                                       placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©..." required
                                       autocomplete="off">
                                <div id="suggestions_en" class="suggestions-list"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="strain_name_th">‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå (‡πÑ‡∏ó‡∏¢)</label>
                            <div class="autocomplete-container">
                                <input type="text" id="strain_name_th" name="strain_name_th" 
                                       placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢..."
                                       autocomplete="off">
                                <div id="suggestions_th" class="suggestions-list"></div>
                            </div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="breeder">‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå</label>
                            <div class="autocomplete-container">
                                <input type="text" id="breeder" name="breeder" placeholder="‡πÄ‡∏ä‡πà‡∏ô DNA Genetics, Barney's Farm" autocomplete="off">
                                <div id="breeder-suggestions" class="suggestions-list"></div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="strain_type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå <span class="required">*</span></label>
                            <select id="strain_type" name="strain_type" required>
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                                <option value="Indica">Indica</option>
                                <option value="Sativa">Sativa</option>
                                <option value="Hybrid">Hybrid</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Chemical Properties -->
                <div class="form-section">
                    <div class="section-title">
                        üß™ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏≤‡∏á‡πÄ‡∏Ñ‡∏°‡∏µ
                    </div>

                    <div class="form-row">
                        <div class="form-group half-width">
                            <label for="thc_percentage">THC (%)</label>
                            <input type="number" id="thc_percentage" name="thc_percentage" step="0.01" min="0" max="100">
                            <div class="help-text">‡∏£‡∏∞‡∏î‡∏±‡∏ö THC ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</div>
                        </div>
                        <div class="form-group half-width">
                            <label for="cbd_percentage">CBD (%)</label>
                            <input type="number" id="cbd_percentage" name="cbd_percentage" step="0.01" min="0" max="100">
                            <div class="help-text">‡∏£‡∏∞‡∏î‡∏±‡∏ö CBD ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå</div>
                        </div>
                        <div class="form-group half-width">
                            <label for="grade">‡πÄ‡∏Å‡∏£‡∏î</label>
                            <select id="grade" name="grade">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏£‡∏î</option>
                                <option value="A+">A+</option>
                                <option value="A">A</option>
                                <option value="B+">B+</option>
                                <option value="B">B</option>
                                <option value="C">C</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Sensory Properties -->
                <div class="form-section">
                    <div class="section-title">
                        üëÉ ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏°‡∏ö‡∏±‡∏ï‡∏¥‡∏ó‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏™‡∏≤‡∏ó‡∏™‡∏±‡∏°‡∏ú‡∏±‡∏™
                    </div>

                    <div class="form-row">
                        <div class="form-group full-width">
                            <label for="aroma_flavor">‡∏Å‡∏•‡∏¥‡πà‡∏ô‡πÅ‡∏•‡∏∞‡∏£‡∏™ (‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ß‡∏¥‡∏£‡πå‡∏î‡∏™‡∏±‡πâ‡∏ô)</label>
                            <textarea id="aroma_flavor" name="aroma_flavor" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏ß‡∏≤‡∏ô ‡∏ã‡∏¥‡∏ï‡∏£‡∏±‡∏™ ‡∏î‡∏¥‡∏ô ‡πÑ‡∏°‡πâ..."></textarea>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="top_terpenes_1">Terpene ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1</label>
                            <input type="text" id="top_terpenes_1" name="top_terpenes_1">
                        </div>
                        <div class="form-group">
                            <label for="top_terpenes_2">Terpene ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 2</label>
                            <input type="text" id="top_terpenes_2" name="top_terpenes_2">
                        </div>
                        <div class="form-group">
                            <label for="top_terpenes_3">Terpene ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 3</label>
                            <input type="text" id="top_terpenes_3" name="top_terpenes_3">
                        </div>
                    </div>
                </div>

                <!-- Effects & Usage -->
                <div class="form-section">
                    <div class="section-title">
                        ‚ú® ‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="effect">‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö</label>
                            <select id="effect" name="effect">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏•‡∏Å‡∏£‡∏∞‡∏ó‡∏ö</option>
                                <option value="‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢">‡∏ú‡πà‡∏≠‡∏ô‡∏Ñ‡∏•‡∏≤‡∏¢</option>
                                <option value="‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏ô">‡∏™‡∏ô‡∏∏‡∏Å‡∏™‡∏ô‡∏≤‡∏ô</option>
                                <option value="‡∏™‡∏á‡∏ö">‡∏™‡∏á‡∏ö</option>
                                <option value="‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏¥‡∏ô‡∏ï‡∏ô‡∏≤‡∏Å‡∏≤‡∏£</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="recommended_time">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥</label>
                            <select id="recommended_time" name="recommended_time">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏ß‡∏•‡∏≤</option>
                                <option value="‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô">‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô</option>
                                <option value="‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô">‡∏Å‡∏•‡∏≤‡∏á‡∏Ñ‡∏∑‡∏ô</option>
                                <option value="‡∏ï‡∏•‡∏≠‡∏î‡∏ß‡∏±‡∏ô">‡∏ï‡∏•‡∏≠‡∏î‡∏ß‡∏±‡∏ô</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Image Upload Section -->
                <div class="form-section">
                    <div class="section-title">
                        üì∏ ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏î‡∏≠‡∏Å
                    </div>

                    <div class="form-row">
                        <div class="form-group half-width">
                            <label for="image_1">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 1</label>
                            <input type="file" id="image_1" name="image_1" accept=".png,.jpg,.jpeg">
                            <div class="help-text">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: PNG, JPG, JPEG</div>
                        </div>
                        <div class="form-group half-width">
                            <label for="image_2">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 2</label>
                            <input type="file" id="image_2" name="image_2" accept=".png,.jpg,.jpeg">
                            <div class="help-text">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: PNG, JPG, JPEG</div>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group half-width">
                            <label for="image_3">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 3</label>
                            <input type="file" id="image_3" name="image_3" accept=".png,.jpg,.jpeg">
                            <div class="help-text">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: PNG, JPG, JPEG</div>
                        </div>
                        <div class="form-group half-width">
                            <label for="image_4">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏ó‡∏µ‡πà 4</label>
                            <input type="file" id="image_4" name="image_4" accept=".png,.jpg,.jpeg">
                            <div class="help-text">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå: PNG, JPG, JPEG</div>
                        </div>
                    </div>
                </div>

                <!-- Growing Information -->
                <div class="form-section">
                    <div class="section-title">
                        üå± ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="grow_method">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å</label>
                            <select id="grow_method" name="grow_method">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏õ‡∏•‡∏π‡∏Å</option>
                                <option value="Indoor">Indoor</option>
                                <option value="Outdoor">Outdoor</option>
                                <option value="Greenhouse">Greenhouse</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="fertilizer_type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏∏‡πà‡∏¢</label>
                            <select id="fertilizer_type" name="fertilizer_type">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏õ‡∏∏‡πà‡∏¢</option>
                                <option value="Organic">Organic</option>
                                <option value="Chemical">Chemical</option>
                                <option value="Mixed">Mixed</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="flowering_type">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏î‡∏≠‡∏Å</label>
                            <select id="flowering_type" name="flowering_type">
                                <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                                <option value="Photoperiod">Photoperiod</option>
                                <option value="Autoflower">Autoflower</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="harvest_date">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Å‡πá‡∏ö‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß</label>
                            <input type="date" id="harvest_date" name="harvest_date">
                        </div>
                        <div class="form-group">
                            <label for="batch_number">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç Batch</label>
                            <input type="text" id="batch_number" name="batch_number">
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
                    </button>
                    <a href="/profile" class="btn btn-secondary">
                        ‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
                    </a>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Autocomplete functionality
        class StrainAutocomplete {
            constructor(inputId, suggestionsId, language) {
                this.input = document.getElementById(inputId);
                this.suggestionsContainer = document.getElementById(suggestionsId);
                this.language = language;
                this.suggestions = [];
                this.selectedIndex = -1;
                this.searchTimeout = null;

                this.init();
            }

            init() {
                this.input.addEventListener('input', (e) => this.handleInput(e));
                this.input.addEventListener('keydown', (e) => this.handleKeydown(e));
                this.input.addEventListener('focus', (e) => this.handleFocus(e));
                this.input.addEventListener('blur', (e) => this.handleBlur(e));
            }

            handleInput(e) {
                const query = e.target.value.trim();

                // Clear previous timeout
                if (this.searchTimeout) {
                    clearTimeout(this.searchTimeout);
                }

                // Debounce search - wait 300ms after user stops typing
                this.searchTimeout = setTimeout(() => {
                    this.searchStrains(query);
                }, 300);
            }

            handleKeydown(e) {
                if (!this.suggestionsContainer.style.display || this.suggestionsContainer.style.display === 'none') {
                    return;
                }

                const items = this.suggestionsContainer.querySelectorAll('.suggestion-item');

                switch (e.key) {
                    case 'ArrowDown':
                        e.preventDefault();
                        this.selectedIndex = Math.min(this.selectedIndex + 1, items.length - 1);
                        this.updateSelection(items);
                        break;
                    case 'ArrowUp':
                        e.preventDefault();
                        this.selectedIndex = Math.max(this.selectedIndex - 1, -1);
                        this.updateSelection(items);
                        break;
                    case 'Enter':
                        e.preventDefault();
                        if (this.selectedIndex >= 0 && items[this.selectedIndex]) {
                            this.selectSuggestion(this.suggestions[this.selectedIndex]);
                        }
                        break;
                    case 'Escape':
                        this.hideSuggestions();
                        break;
                }
            }

            handleFocus(e) {
                // Show popular strains when input is focused and empty
                if (!e.target.value.trim()) {
                    this.searchStrains('');
                }
            }

            handleBlur(e) {
                // Hide suggestions after a short delay to allow for clicking
                setTimeout(() => {
                    this.hideSuggestions();
                }, 150);
            }

            updateSelection(items) {
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === this.selectedIndex);
                });
            }

            async searchStrains(query) {
                try {
                    const response = await fetch(`/api/strains/search?q=${encodeURIComponent(query)}&lang=${this.language}&limit=10`);

                    if (!response.ok) {
                        throw new Error('Search failed');
                    }

                    this.suggestions = await response.json();
                    this.displaySuggestions();
                } catch (error) {
                    console.error('Error fetching suggestions:', error);
                    this.suggestions = [];
                    this.displaySuggestions();
                }
            }

            displaySuggestions() {
                this.suggestionsContainer.innerHTML = '';
                this.selectedIndex = -1;

                if (this.suggestions.length === 0) {
                    const noResults = document.createElement('div');
                    noResults.className = 'no-suggestions';
                    noResults.textContent = '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏≤‡∏¢‡∏û‡∏±‡∏ô‡∏ò‡∏∏‡πå‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ñ‡∏≥‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤';
                    this.suggestionsContainer.appendChild(noResults);
                    this.showSuggestions();
                    return;
                }

                this.suggestions.forEach((suggestion, index) => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';

                    const mainDiv = document.createElement('div');
                    mainDiv.className = 'suggestion-main';
                    mainDiv.textContent = suggestion.name;

                    const metaDiv = document.createElement('div');
                    metaDiv.className = 'suggestion-meta';

                    if (suggestion.is_popular) {
                        const popularBadge = document.createElement('span');
                        popularBadge.className = 'popular-badge';
                        popularBadge.textContent = '‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°';
                        metaDiv.appendChild(popularBadge);
                    }

                    if (suggestion.strain_type) {
                        const typeBadge = document.createElement('span');
                        typeBadge.className = 'strain-type-badge';
                        typeBadge.textContent = suggestion.strain_type;
                        metaDiv.appendChild(typeBadge);
                    }

                    item.appendChild(mainDiv);
                    item.appendChild(metaDiv);

                    item.addEventListener('click', () => {
                        this.selectSuggestion(suggestion);
                    });

                    this.suggestionsContainer.appendChild(item);
                });

                this.showSuggestions();
            }

            selectSuggestion(suggestion) {
                this.input.value = suggestion.name;
                this.hideSuggestions();

                // Auto-fill strain type if available
                if (suggestion.strain_type) {
                    const strainTypeSelect = document.getElementById('strain_type');
                    if (strainTypeSelect && strainTypeSelect.value === '') {
                        strainTypeSelect.value = suggestion.strain_type;
                    }
                }
            }

            showSuggestions() {
                this.suggestionsContainer.style.display = 'block';
            }

            hideSuggestions() {
                this.suggestionsContainer.style.display = 'none';
            }
        }

        // Initialize autocomplete for breeders
        function initializeBreederAutocomplete(inputId, suggestionsId, apiUrl) {
            const input = document.getElementById(inputId);
            const suggestionsContainer = document.getElementById(suggestionsId);
            let currentSelection = -1;
            let suggestions = [];

            function showSuggestions(data) {
                suggestionsContainer.innerHTML = '';
                suggestions = data;
                currentSelection = -1;

                if (data.length === 0) {
                    suggestionsContainer.style.display = 'none';
                    return;
                }

                data.forEach((suggestion, index) => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';

                    const mainDiv = document.createElement('div');
                    mainDiv.className = 'suggestion-main';
                    mainDiv.textContent = suggestion.name;

                    const metaDiv = document.createElement('div');
                    metaDiv.className = 'suggestion-meta';

                    if (suggestion.is_popular) {
                        const popularBadge = document.createElement('span');
                        popularBadge.className = 'popular-badge';
                        popularBadge.textContent = '‡∏¢‡∏≠‡∏î‡∏ô‡∏¥‡∏¢‡∏°';
                        metaDiv.appendChild(popularBadge);
                    }

                    item.appendChild(mainDiv);
                    item.appendChild(metaDiv);

                    item.addEventListener('click', () => {
                        input.value = suggestion.name;
                        suggestionsContainer.style.display = 'none';
                        input.focus();
                    });

                    suggestionsContainer.appendChild(item);
                });

                suggestionsContainer.style.display = 'block';
            }

            function hideSuggestions() {
                setTimeout(() => {
                    suggestionsContainer.style.display = 'none';
                }, 200);
            }

            function updateSelection() {
                const items = suggestionsContainer.querySelectorAll('.suggestion-item');
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === currentSelection);
                });
            }

            input.addEventListener('input', async (e) => {
                const query = e.target.value.trim();

                try {
                    const response = await fetch(`${apiUrl}?q=${encodeURIComponent(query)}&limit=10`);
                    const data = await response.json();
                    showSuggestions(data);
                } catch (error) {
                    console.error('Error fetching breeder suggestions:', error);
                    suggestionsContainer.innerHTML = '<div class="suggestion-item">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</div>';
                    suggestionsContainer.style.display = 'block';
                }
            });

            input.addEventListener('focus', async () => {
                if (input.value.trim() === '') {
                    try {
                        const response = await fetch(`${apiUrl}?q=&limit=10`);
                        const data = await response.json();
                        showSuggestions(data);
                    } catch (error) {
                        console.error('Error fetching popular breeders:', error);
                    }
                }
            });

            input.addEventListener('blur', hideSuggestions);

            input.addEventListener('keydown', (e) => {
                const items = suggestionsContainer.querySelectorAll('.suggestion-item');

                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentSelection = Math.min(currentSelection + 1, items.length - 1);
                    updateSelection();
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentSelection = Math.max(currentSelection - 1, -1);
                    updateSelection();
                } else if (e.key === 'Enter' && currentSelection >= 0) {
                    e.preventDefault();
                    if (suggestions[currentSelection]) {
                        input.value = suggestions[currentSelection].name;
                        suggestionsContainer.style.display = 'none';
                    }
                } else if (e.key === 'Escape') {
                    suggestionsContainer.style.display = 'none';
                    currentSelection = -1;
                }
            });
        }

        // Initialize autocomplete for strain names
        document.addEventListener('DOMContentLoaded', function() {
            new StrainAutocomplete('strain_name_en', 'suggestions_en', 'en');
            new StrainAutocomplete('strain_name_th', 'suggestions_th', 'th');

            // Initialize autocomplete for breeders
            initializeBreederAutocomplete('breeder', 'breeder-suggestions', '/api/breeders/search');
        });

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';

            alertContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;

            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }

        document.getElementById('budsForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const formData = new FormData(this);
            const data = {};
            const imageFiles = new FormData();

            // Separate text data and image files
            for (let [key, value] of formData.entries()) {
                if (key.startsWith('image_') && value instanceof File && value.size > 0) {
                    imageFiles.append(key, value);
                } else if (typeof value === 'string' && value.trim() !== '') {
                    // Convert numeric fields
                    if (key === 'thc_percentage' || key === 'cbd_percentage') {
                        data[key] = parseFloat(value);
                    } else {
                        data[key] = value;
                    }
                }
            }

            try {
                // First, create the bud record
                const budResponse = await fetch('/api/buds', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });

                if (!budResponse.ok) {
                    throw new Error(budResult.error || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                }

                const budId = budResult.bud_id;
                let uploadMessage = budResult.message;

                // Then, upload images if any
                let hasImages = false;
                for (let [key, value] of imageFiles.entries()) {
                    if (value instanceof File && value.size > 0) {
                        hasImages = true;
                        break;
                    }
                }

                if (hasImages) {
                    try {
                        const imageResponse = await fetch(`/api/buds/${budId}/upload-images`, {
                            method: 'POST',
                            body: imageFiles
                        });

                        const imageUploadResult = await imageResponse.json();

                        if (imageResponse.ok && imageUploadResult.success) {
                            uploadMessage += ` ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (${imageUploadResult.uploaded_images.length} ‡∏£‡∏π‡∏õ)`;
                        } else {
                            uploadMessage += ` ‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${imageUploadResult.error}`;
                        }
                    } catch (imageError) {
                        console.error('Image upload error:', imageError);
                        uploadMessage += ` ‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏û‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß`;
                    }
                }

                showAlert(uploadMessage, 'success');

                // Reset form
                document.getElementById('budsForm').reset();

                // Redirect to profile after 3 seconds
                setTimeout(() => {
                    window.location.href = '/profile';
                }, 3000);

            } catch (error) {
                console.error('Error:', error);
                showAlert(error.message || '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', 'error');
            }
        });
    </script>
</body>
</html>