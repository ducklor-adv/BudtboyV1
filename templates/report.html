
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cannabis App - ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            padding: 20px 30px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .header-title {
            text-align: center;
            flex: 1;
        }
        
        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }
        
        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #2196F3;
        }
        
        .summary-number {
            font-size: 32px;
            font-weight: 600;
            color: #2196F3;
            margin-bottom: 5px;
        }
        
        .summary-label {
            color: #666;
            font-size: 14px;
        }
        
        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }
        
        .print-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-left: 10px;
        }
        
        .print-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }
        
        /* Print styles */
        @media print {
            body {
                background: white !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
            }
            
            .controls {
                display: none !important;
            }
            
            .back-btn {
                display: none !important;
            }
            
            .header {
                background: #2196F3 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                print-color-adjust: exact;
            }
            
            .summary-cards {
                background: white !important;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }
            
            .data-table {
                font-size: 11px !important;
                page-break-inside: auto;
            }
            
            .data-table th,
            .data-table td {
                padding: 6px 4px !important;
                border: 1px solid #ddd !important;
            }
            
            .data-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }
            
            .summary-card {
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }
            
            .strain-type,
            .grade-badge {
                border: 1px solid #333 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
            
            .rating-stars {
                color: #000 !important;
            }
        }
        
        .table-container {
            padding: 30px;
            overflow-x: auto;
        }
        
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
        }
        
        .data-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
        }
        
        .data-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
        }
        
        .data-table tr:hover {
            background: #f8f9fa;
        }
        
        .strain-name {
            font-weight: 600;
            color: #333;
        }
        
        .strain-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }
        
        .type-indica {
            background: #e8eaf6;
            color: #3f51b5;
        }
        
        .type-sativa {
            background: #e8f5e9;
            color: #4caf50;
        }
        
        .type-hybrid {
            background: #fff3e0;
            color: #ff9800;
        }
        
        .rating-display {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .rating-stars {
            color: #ffd700;
            font-size: 16px;
        }
        
        .rating-number {
            font-weight: 600;
            color: #333;
        }
        
        .review-count {
            color: #666;
            font-size: 12px;
        }
        
        .thc-cbd-display {
            font-size: 12px;
            line-height: 1.4;
        }
        
        .thc {
            color: #ff6b6b;
            font-weight: 600;
        }
        
        .cbd {
            color: #4ecdc4;
            font-weight: 600;
        }
        
        .grade-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }
        
        .grade-a-plus {
            background: #d4edda;
            color: #155724;
        }
        
        .grade-a {
            background: #cce5ff;
            color: #0066cc;
        }
        
        .grade-b-plus {
            background: #fff2cc;
            color: #996600;
        }
        
        .grade-b {
            background: #ffe6cc;
            color: #cc6600;
        }
        
        .grade-c {
            background: #f8d7da;
            color: #721c24;
        }
        
        .grower-info {
            font-size: 12px;
            color: #666;
        }
        
        .verified-grower {
            color: #28a745;
            font-weight: 600;
        }
        
        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 60px;
            color: #dc3545;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px;
            color: #666;
        }
        
        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                padding: 20px;
                gap: 15px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .filter-group {
                justify-content: center;
            }
            
            .table-container {
                padding: 20px;
            }
            
            .data-table {
                font-size: 12px;
            }
            
            .data-table th,
            .data-table td {
                padding: 8px 4px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/profile" class="back-btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
            <div class="header-title">
                <h1>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h1>
            </div>
            <div style="width: 60px;"></div>
        </div>
        
        <div class="summary-cards" id="summaryCards">
            <div class="summary-card">
                <div class="summary-number" id="totalBuds">-</div>
                <div class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="totalReviews">-</div>
                <div class="summary-label">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="avgRating">-</div>
                <div class="summary-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="totalGrowers">-</div>
                <div class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏•‡∏π‡∏Å</div>
            </div>
        </div>
        
        <div class="controls">
            <div class="filter-group">
                <label>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:</label>
                <select id="strainTypeFilter" class="filter-select">
                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="Indica">Indica</option>
                    <option value="Sativa">Sativa</option>
                    <option value="Hybrid">Hybrid</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>‡∏Å‡∏£‡∏≠‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏Å‡∏£‡∏î:</label>
                <select id="gradeFilter" class="filter-select">
                    <option value="">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option>
                    <option value="A+">A+</option>
                    <option value="A">A</option>
                    <option value="B+">B+</option>
                    <option value="B">B</option>
                    <option value="C">C</option>
                </select>
            </div>
            
            <button id="exportBtn" class="export-btn" onclick="exportToCSV()">
                üì• ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å CSV
            </button>
            
            <button id="printBtn" class="print-btn" onclick="printToPDF()">
                üìÑ ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏õ‡πá‡∏ô PDF
            </button>
        </div>
        
        <div class="table-container">
            <div id="loadingMessage" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            <div id="errorMessage" class="error" style="display: none;"></div>
            
            <table id="dataTable" class="data-table" style="display: none;">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠‡∏î‡∏≠‡∏Å</th>
                        <th>‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢</th>
                        <th>‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤</th>
                        <th>‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</th>
                        <th>THC/CBD</th>
                        <th>‡πÄ‡∏Å‡∏£‡∏î</th>
                        <th>‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</th>
                        <th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</th>
                        <th>‡∏ú‡∏π‡πâ‡∏õ‡∏•‡∏π‡∏Å</th>
                        <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <script>
        let allBudsData = [];
        let filteredData = [];
        
        window.addEventListener('load', async () => {
            await loadAllBudsData();
            setupFilters();
        });
        
        async function loadAllBudsData() {
            try {
                const response = await fetch('/api/all-buds-report');
                if (response.ok) {
                    const data = await response.json();
                    allBudsData = data.buds || [];
                    filteredData = [...allBudsData];
                    
                    updateSummaryCards();
                    displayTable();
                    
                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('dataTable').style.display = 'table';
                } else {
                    throw new Error('Failed to load data');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        }
        
        function updateSummaryCards() {
            const totalBuds = allBudsData.length;
            const totalReviews = allBudsData.reduce((sum, bud) => sum + (bud.review_count || 0), 0);
            const ratingsSum = allBudsData.reduce((sum, bud) => sum + ((bud.avg_rating || 0) * (bud.review_count || 0)), 0);
            const avgRating = totalReviews > 0 ? (ratingsSum / totalReviews).toFixed(1) : '0.0';
            const uniqueGrowers = new Set(allBudsData.map(bud => bud.grower_id)).size;
            
            document.getElementById('totalBuds').textContent = totalBuds;
            document.getElementById('totalReviews').textContent = totalReviews;
            document.getElementById('avgRating').textContent = avgRating;
            document.getElementById('totalGrowers').textContent = uniqueGrowers;
        }
        
        function setupFilters() {
            document.getElementById('strainTypeFilter').addEventListener('change', applyFilters);
            document.getElementById('gradeFilter').addEventListener('change', applyFilters);
        }
        
        function applyFilters() {
            const strainTypeFilter = document.getElementById('strainTypeFilter').value;
            const gradeFilter = document.getElementById('gradeFilter').value;
            
            filteredData = allBudsData.filter(bud => {
                if (strainTypeFilter && bud.strain_type !== strainTypeFilter) return false;
                if (gradeFilter && bud.grade !== gradeFilter) return false;
                return true;
            });
            
            displayTable();
        }
        
        function displayTable() {
            const tbody = document.getElementById('tableBody');
            
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="empty-state">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏≠‡∏á</td></tr>';
                return;
            }
            
            tbody.innerHTML = filteredData.map(bud => `
                <tr>
                    <td>${bud.id}</td>
                    <td class="strain-name">${bud.strain_name_en || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
                    <td>${bud.strain_name_th || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
                    <td>${bud.breeder || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
                    <td>
                        <span class="strain-type ${getStrainTypeClass(bud.strain_type)}">
                            ${bud.strain_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                        </span>
                    </td>
                    <td class="thc-cbd-display">
                        <div class="thc">THC: ${bud.thc_percentage || 'N/A'}%</div>
                        <div class="cbd">CBD: ${bud.cbd_percentage || 'N/A'}%</div>
                    </td>
                    <td>
                        <span class="grade-badge ${getGradeClass(bud.grade)}">
                            ${bud.grade || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                        </span>
                    </td>
                    <td class="rating-display">
                        <div class="rating-stars">${'‚≠ê'.repeat(Math.round(bud.avg_rating || 0))}</div>
                        <div class="rating-number">${(bud.avg_rating || 0).toFixed(1)}</div>
                    </td>
                    <td class="review-count">${bud.review_count || 0} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</td>
                    <td class="grower-info">
                        <div ${bud.grower_license_verified ? 'class="verified-grower"' : ''}>
                            ${bud.grower_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            ${bud.grower_license_verified ? ' ‚úÖ' : ''}
                        </div>
                    </td>
                    <td>${formatDate(bud.created_at)}</td>
                </tr>
            `).join('');
        }
        
        function getStrainTypeClass(type) {
            switch(type) {
                case 'Indica': return 'type-indica';
                case 'Sativa': return 'type-sativa';
                case 'Hybrid': return 'type-hybrid';
                default: return '';
            }
        }
        
        function getGradeClass(grade) {
            switch(grade) {
                case 'A+': return 'grade-a-plus';
                case 'A': return 'grade-a';
                case 'B+': return 'grade-b-plus';
                case 'B': return 'grade-b';
                case 'C': return 'grade-c';
                default: return '';
            }
        }
        
        function formatDate(dateString) {
            if (!dateString) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }
        
        function exportToCSV() {
            const headers = ['ID', '‡∏ä‡∏∑‡πà‡∏≠‡∏î‡∏≠‡∏Å (EN)', '‡∏ä‡∏∑‡πà‡∏≠‡∏î‡∏≠‡∏Å (TH)', '‡∏ú‡∏π‡πâ‡∏û‡∏±‡∏í‡∏ô‡∏≤', '‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó', 'THC%', 'CBD%', '‡πÄ‡∏Å‡∏£‡∏î', '‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢', '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß', '‡∏ú‡∏π‡πâ‡∏õ‡∏•‡∏π‡∏Å', '‡∏°‡∏µ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï', '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°'];
            
            const csvContent = [
                headers.join(','),
                ...filteredData.map(bud => [
                    bud.id,
                    `"${bud.strain_name_en || ''}"`,
                    `"${bud.strain_name_th || ''}"`,
                    `"${bud.breeder || ''}"`,
                    `"${bud.strain_type || ''}"`,
                    bud.thc_percentage || '',
                    bud.cbd_percentage || '',
                    `"${bud.grade || ''}"`,
                    (bud.avg_rating || 0).toFixed(1),
                    bud.review_count || 0,
                    `"${bud.grower_name || ''}"`,
                    bud.grower_license_verified ? '‡πÉ‡∏ä‡πà' : '‡πÑ‡∏°‡πà',
                    formatDate(bud.created_at)
                ].join(','))
            ].join('\n');
            
            const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `cannabis_report_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        function printToPDF() {
            // Hide elements that shouldn't be printed
            const controlsElement = document.querySelector('.controls');
            const originalDisplay = controlsElement.style.display;
            
            // Temporarily hide controls for printing
            controlsElement.style.display = 'none';
            
            // Set page title for PDF
            const originalTitle = document.title;
            document.title = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î_${new Date().toISOString().split('T')[0]}`;
            
            // Open print dialog
            window.print();
            
            // Restore original state after printing
            setTimeout(() => {
                controlsElement.style.display = originalDisplay;
                document.title = originalTitle;
            }, 1000);
        }
    </script>
</body>
</html>
