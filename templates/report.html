<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cannabis App - ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #e8f5e8 0%, #f0f8ff 100%);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #2196F3, #1976D2);
            padding: 20px 30px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            text-decoration: none;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .header-title {
            text-align: center;
            flex: 1;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
        }

        .summary-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 4px solid #2196F3;
        }

        .summary-number {
            font-size: 32px;
            font-weight: 600;
            color: #2196F3;
            margin-bottom: 5px;
        }

        .summary-label {
            color: #666;
            font-size: 14px;
        }

        .controls {
            padding: 20px 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .filter-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .filter-select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        .export-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .export-btn:hover {
            background: #218838;
            transform: translateY(-1px);
        }

        .print-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .print-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        /* Print styles */
        @media print {
            body {
                background: white !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }

            .container {
                box-shadow: none !important;
                border-radius: 0 !important;
                margin: 0 !important;
                max-width: 100% !important;
            }

            .controls {
                display: none !important;
            }

            .back-btn {
                display: none !important;
            }

            .header {
                background: #2196F3 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
                print-color-adjust: exact;
            }

            .summary-cards {
                background: white !important;
                border: 1px solid #ddd;
                page-break-inside: avoid;
            }

            .data-table {
                font-size: 11px !important;
                page-break-inside: auto;
            }

            .data-table th,
            .data-table td {
                padding: 6px 4px !important;
                border: 1px solid #ddd !important;
            }

            .data-table tr {
                page-break-inside: avoid;
                page-break-after: auto;
            }

            .summary-card {
                border: 1px solid #ddd !important;
                page-break-inside: avoid;
            }

            .strain-type,
            .grade-badge {
                border: 1px solid #333 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }

            .rating-stars {
                color: #000 !important;
            }
        }

        .table-container {
            padding: 30px;
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-size: 14px;
            position: relative;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 12px 8px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            white-space: nowrap;
            cursor: pointer;
            position: relative;
            transition: background-color 0.2s ease;
        }

        .data-table th:hover {
            background: #e9ecef;
        }

        /* Sticky column for strain name (2nd column) */
        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            position: sticky;
            left: 0;
            background: #f8f9fa;
            z-index: 5;
            border-right: 2px solid #dee2e6;
            box-shadow: 2px 0 4px rgba(0,0,0,0.1);
        }

        .data-table td:nth-child(2) {
            background: inherit;
        }

        /* Alternating row colors with light green theme */
        .data-table tr:nth-child(even) {
            background: #f0f8f0;
        }

        .data-table tr:nth-child(odd) {
            background: #ffffff;
        }

        .data-table tr:nth-child(even) td:nth-child(2) {
            background: #e8f5e8;
        }

        .data-table tr:nth-child(odd) td:nth-child(2) {
            background: #f8f9fa;
        }

        .sort-indicator {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #6c757d;
        }

        .sort-asc::after {
            content: "‚ñ≤";
        }

        .sort-desc::after {
            content: "‚ñº";
        }

        .filter-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
        }

        .filter-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            font-size: 12px;
            transition: background-color 0.2s ease;
        }

        .filter-option:hover {
            background: #f8f9fa;
        }

        .filter-option:last-child {
            border-bottom: none;
        }

        .filter-option.selected {
            background: #e3f2fd;
            color: #1976d2;
            font-weight: 600;
        }

        .filter-clear {
            padding: 8px 12px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-size: 12px;
            color: #dc3545;
            cursor: pointer;
            font-weight: 600;
        }

        .filter-clear:hover {
            background: #e9ecef;
        }

        .filter-indicator {
            position: absolute;
            right: 20px;
            top: 50%;
            transform: translateY(-50%);
            width: 8px;
            height: 8px;
            background: #2196F3;
            border-radius: 50%;
            display: none;
        }

        .data-table th {
            position: relative;
        }

        .data-table td {
            padding: 12px 8px;
            border-bottom: 1px solid #dee2e6;
            vertical-align: top;
        }

        .data-table tr:hover {
            background: #e8f5e8;
        }

        .data-table tr:hover td:nth-child(2) {
            background: #d4edda;
        }

        .strain-name {
            font-weight: 600;
            color: #333;
        }

        .strain-type {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .type-indica {
            background: #e8eaf6;
            color: #3f51b5;
        }

        .type-sativa {
            background: #e8f5e9;
            color: #4caf50;
        }

        .type-hybrid {
            background: #fff3e0;
            color: #ff9800;
        }

        .rating-display {
            display: flex;
            align-items: center;
            gap: 5px;
            justify-content: flex-start;
        }

        .rating-stars {
            color: #ffd700;
            font-size: 16px;
        }

        .rating-number {
            font-weight: 600;
            color: #333;
        }

        .review-count {
            color: #666;
            font-size: 12px;
        }

        .thc-cbd-display {
            font-size: 12px;
            line-height: 1.4;
        }

        .thc {
            color: #ff6b6b;
            font-weight: 600;
        }

        .cbd {
            color: #4ecdc4;
            font-weight: 600;
        }

        .grade-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .grade-a-plus {
            background: #d4edda;
            color: #155724;
        }

        .grade-a {
            background: #cce5ff;
            color: #0066cc;
        }

        .grade-b-plus {
            background: #fff2cc;
            color: #996600;
        }

        .grade-b {
            background: #ffe6cc;
            color: #cc6600;
        }

        .grade-c {
            background: #f8d7da;
            color: #721c24;
        }

        .grower-info {
            font-size: 12px;
            color: #666;
        }

        .verified-grower {
            color: #28a745;
            font-weight: 600;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .error {
            text-align: center;
            padding: 60px;
            color: #dc3545;
        }

        .empty-state {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .full-report-btn {
            background: linear-gradient(135deg, #ff4757, #ff3742);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-block;
            text-align: center;
            white-space: nowrap;
        }

        .full-report-btn:hover {
            background: linear-gradient(135deg, #ff3742, #ff2f3a);
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(255, 71, 87, 0.3);
        }

        .status-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
        }

        .status-available {
            background: #d4edda;
            color: #155724;
        }

        .status-sold-out {
            background: #f8d7da;
            color: #721c24;
        }

        /* Bottom Navigation Styling */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: white;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            padding: 10px 0;
            z-index: 100;
        }

        .nav-tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #6c757d;
            font-size: 12px;
            transition: color 0.3s ease;
            flex: 1;
            text-align: center;
        }

        .nav-tab.active {
            color: #007bff; /* Or any active color you prefer */
            font-weight: 600;
        }

        .nav-icon {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .nav-label {
            font-size: 10px;
        }


        @media (max-width: 768px) {
            body {
                padding: 0;
                margin: 0;
            }

            .container {
                margin: 0;
                border-radius: 0;
                max-width: 100%;
                min-height: 100vh;
            }

            .header {
                padding: 15px 20px;
                border-radius: 0;
            }

            .header h1 {
                font-size: 18px !important;
            }

            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
                padding: 15px;
                gap: 10px;
                margin: 0;
                border-radius: 0;
            }

            .summary-card {
                padding: 15px 10px;
                border-radius: 8px;
            }

            .summary-number {
                font-size: 24px;
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
                padding: 15px 20px;
                border-radius: 0;
            }

            .filter-group {
                justify-content: center;
            }

            .table-container {
                padding: 15px;
                overflow-x: auto;
            }

            .data-table {
                font-size: 11px;
                min-width: 800px;
            }

            .data-table th,
            .data-table td {
                padding: 6px 3px;
                min-width: 80px;
            }

            .data-table th {
                font-size: 10px;
                position: sticky;
                top: 0;
                background: #f8f9fa;
                z-index: 10;
            }

            .data-table th:nth-child(2),
            .data-table td:nth-child(2) {
                position: sticky;
                left: 0;
                z-index: 15;
                border-right: 1px solid #dee2e6;
                box-shadow: 1px 0 2px rgba(0,0,0,0.1);
            }

            .strain-name {
                font-size: 12px;
                max-width: 120px;
                word-wrap: break-word;
            }

            .strain-type {
                font-size: 10px;
                padding: 2px 4px;
            }

            .grade-badge {
                font-size: 10px;
                padding: 2px 4px;
            }

            .rating-display {
                flex-direction: column;
                gap: 2px;
            }

            .rating-stars {
                font-size: 12px;
            }

            .rating-number {
                font-size: 11px;
            }

            .thc-cbd-display {
                font-size: 10px;
            }

            .full-report-btn {
                font-size: 10px;
                padding: 4px 6px;
                white-space: nowrap;
            }

            .grower-info {
                font-size: 10px;
                max-width: 100px;
                word-wrap: break-word;
            }

            .back-btn {
                padding: 8px 12px;
                font-size: 12px;
            }

            .export-btn {
                padding: 8px 15px;
                font-size: 12px;
                width: 100%;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <a href="/profile" class="back-btn">‚Üê ‡∏Å‡∏•‡∏±‡∏ö</a>
            <div class="header-title">
                <h1>üìä ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h1>
            </div>
            <div style="width: 60px;"></div>
        </div>

        <div class="summary-cards" id="summaryCards">
            <div class="summary-card">
                <div class="summary-number" id="totalBuds">-</div>
                <div class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏î‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="totalReviews">-</div>
                <div class="summary-label">‡∏£‡∏µ‡∏ß‡∏¥‡∏ß‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="avgRating">-</div>
                <div class="summary-label">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢</div>
            </div>
            <div class="summary-card">
                <div class="summary-number" id="totalGrowers">-</div>
                <div class="summary-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡∏•‡∏π‡∏Å</div>
            </div>
        </div>

        <div class="controls">
            <div class="filter-group">
                <a href="/search-tool" class="export-btn" style="text-decoration: none; margin-right: 15px;">
                    üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                </a>
            </div>
        </div>

        <div class="table-container">
            <div id="loadingMessage" class="loading">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</div>
            <div id="errorMessage" class="error" style="display: none;"></div>

            <table id="dataTable" class="data-table" style="display: none;">
                <thead>
                    <tr>
                        <th onclick="handleHeaderClick(event, 'id')" data-column="id">
                            ID
                            <span class="sort-indicator" id="sort-id"></span>
                            <span class="filter-indicator" id="filter-id"></span>
                            <div class="filter-dropdown" id="dropdown-id"></div>
                        </th>
                        <th onclick="handleHeaderClick(event, 'strain_name_en')" data-column="strain_name_en">
                            ‡∏ä‡∏∑‡πà‡∏≠‡∏î‡∏≠‡∏Å
                            <span class="sort-indicator" id="sort-strain_name_en"></span>
                            <span class="filter-indicator" id="filter-strain_name_en"></span>
                            <div class="filter-dropdown" id="dropdown-strain_name_en"></div>
                        </th>
                        <th onclick="handleHeaderClick(event, 'strain_name_th')" data-column="strain_name_th">
                            ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢
                            <span class="sort-indicator" id="sort-strain_name_th"></span>
                            <span class="filter-indicator" id="filter-strain_name_th"></span>
                            <div class="filter-dropdown" id="dropdown-strain_name_th"></div>
                        </th>
                        <th onclick="handleHeaderClick(event, 'strain_type')" data-column="strain_type">
                            ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
                            <span class="sort-indicator" id="sort-strain_type"></span>
                            <span class="filter-indicator" id="filter-strain_type"></span>
                            <div class="filter-dropdown" id="dropdown-strain_type"></div>
                        </th>
                        <th onclick="handleHeaderClick(event, 'thc_percentage')" data-column="thc_percentage">
                            THC/CBD
                            <span class="sort-indicator" id="sort-thc_percentage"></span>
                            <span class="filter-indicator" id="filter-thc_percentage"></span>
                            <div class="filter-dropdown" id="dropdown-thc_percentage"></div>
                        </th>
                        <th onclick="handleHeaderClick(event, 'grade')" data-column="grade">
                            ‡πÄ‡∏Å‡∏£‡∏î
                            <span class="sort-indicator" id="sort-grade"></span>
                            <span class="filter-indicator" id="filter-grade"></span>
                            <div class="filter-dropdown" id="dropdown-grade"></div>
                        </th>
                        <th onclick="handleHeaderClick(event, 'avg_rating')" data-column="avg_rating">
                            ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢
                            <span class="sort-indicator" id="sort-avg_rating"></span>
                            <span class="filter-indicator" id="filter-avg_rating"></span>
                            <div class="filter-dropdown" id="dropdown-avg_rating"></div>
                        </th>
                        <th onclick="handleHeaderClick(event, 'review_count')" data-column="review_count">
                            ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏£‡∏µ‡∏ß‡∏¥‡∏ß
                            <span class="sort-indicator" id="sort-review_count"></span>
                            <span class="filter-indicator" id="filter-review_count"></span>
                            <div class="filter-dropdown" id="dropdown-review_count"></div>
                        </th>
                        <th onclick="handleHeaderClick(event, 'grower_name')" data-column="grower_name">
                            ‡∏ú‡∏π‡πâ‡∏õ‡∏•‡∏π‡∏Å
                            <span class="sort-indicator" id="sort-grower_name"></span>
                            <span class="filter-indicator" id="filter-grower_name"></span>
                            <div class="filter-dropdown" id="dropdown-grower_name"></div>
                        </th>
                        <th onclick="handleHeaderClick(event, 'status')" data-column="status">
                            ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
                            <span class="sort-indicator" id="sort-status"></span>
                            <span class="filter-indicator" id="filter-status"></span>
                            <div class="filter-dropdown" id="dropdown-status"></div>
                        </th>
                        <th onclick="handleHeaderClick(event, 'created_at')" data-column="created_at">
                            ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°
                            <span class="sort-indicator" id="sort-created_at"></span>
                            <span class="filter-indicator" id="filter-created_at"></span>
                            <div class="filter-dropdown" id="dropdown-created_at"></div>
                        </th>
                        <th>‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <a href="/activity" class="nav-tab">
            <div class="nav-icon">üìä</div>
            <div class="nav-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏°</div>
        </a>
        <a href="/search-tool" class="nav-tab">
            <div class="nav-icon">üîç</div>
            <div class="nav-label">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        </a>
        <a href="/report" class="nav-tab active">
            <div class="nav-icon">üìà</div>
            <div class="nav-label">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div>
        </a>
        <a href="/profile" class="nav-tab">
            <div class="nav-icon">üë§</div>
            <div class="nav-label">‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</div>
        </a>
    </div>

    <script>
        let allBudsData = [];
        let filteredBudsData = [];
        let currentSortColumn = null;
        let currentSortDirection = 'asc';
        let activeFilters = {};

        window.addEventListener('load', async () => {
            await loadAllBudsData();
        });

        async function loadAllBudsData() {
            try {
                const response = await fetch('/api/all-buds-report');
                if (response.ok) {
                    const data = await response.json();
                    allBudsData = data.buds || [];

                    updateSummaryCards();
                    displayTable();

                    document.getElementById('loadingMessage').style.display = 'none';
                    document.getElementById('dataTable').style.display = 'table';
                } else {
                    throw new Error('Failed to load data');
                }
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('loadingMessage').style.display = 'none';
                document.getElementById('errorMessage').style.display = 'block';
                document.getElementById('errorMessage').textContent = '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•';
            }
        }

        function updateSummaryCards() {
            const dataToUse = filteredBudsData.length > 0 ? filteredBudsData : allBudsData;
            const totalBuds = dataToUse.length;
            const totalReviews = dataToUse.reduce((sum, bud) => sum + (bud.review_count || 0), 0);
            const ratingsSum = dataToUse.reduce((sum, bud) => sum + ((bud.avg_rating || 0) * (bud.review_count || 0)), 0);
            const avgRating = totalReviews > 0 ? (ratingsSum / totalReviews).toFixed(1) : '0.0';
            const uniqueGrowers = new Set(dataToUse.map(bud => bud.grower_id)).size;

            document.getElementById('totalBuds').textContent = totalBuds;
            document.getElementById('totalReviews').textContent = totalReviews;
            document.getElementById('avgRating').textContent = avgRating;
            document.getElementById('totalGrowers').textContent = uniqueGrowers;
        }

        function handleHeaderClick(event, column) {
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏™‡πà‡∏ß‡∏ô‡πÑ‡∏´‡∏ô
            const rect = event.currentTarget.getBoundingClientRect();
            const clickX = event.clientX - rect.left;
            const headerWidth = rect.width;

            // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Ç‡∏ß‡∏≤‡∏™‡∏∏‡∏î (30px) ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á filter
            if (clickX > headerWidth - 30) {
                toggleFilterDropdown(column);
            } else {
                // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏≠‡∏∑‡πà‡∏ô ‡πÉ‡∏´‡πâ sort
                sortTable(column);
            }
        }

        function toggleFilterDropdown(column) {
            // ‡∏õ‡∏¥‡∏î dropdown ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ ‡∏Å‡πà‡∏≠‡∏ô
            document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
                if (dropdown.id !== `dropdown-${column}`) {
                    dropdown.style.display = 'none';
                }
            });

            const dropdown = document.getElementById(`dropdown-${column}`);
            const isVisible = dropdown.style.display === 'block';

            if (isVisible) {
                dropdown.style.display = 'none';
            } else {
                populateFilterDropdown(column);
                dropdown.style.display = 'block';
            }
        }

        function populateFilterDropdown(column) {
            const dropdown = document.getElementById(`dropdown-${column}`);
            const uniqueValues = [...new Set(allBudsData.map(bud => {
                let value = bud[column];
                if (value == null || value === '') return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                if (column === 'created_at') {
                    return formatDate(value);
                }
                return String(value);
            }))].sort();

            let html = '<div class="filter-clear" onclick="clearFilter(\'' + column + '\')">‡∏•‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á</div>';

            uniqueValues.forEach(value => {
                const isSelected = activeFilters[column] === value;
                html += `<div class="filter-option ${isSelected ? 'selected' : ''}" onclick="applyFilter('${column}', '${value}')">${value}</div>`;
            });

            dropdown.innerHTML = html;
        }

        function applyFilter(column, value) {
            if (value === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏') {
                activeFilters[column] = null;
            } else {
                activeFilters[column] = value;
            }

            // ‡πÅ‡∏™‡∏î‡∏á filter indicator
            const indicator = document.getElementById(`filter-${column}`);
            if (indicator) {
                indicator.style.display = 'block';
            }

            // ‡∏õ‡∏¥‡∏î dropdown
            document.getElementById(`dropdown-${column}`).style.display = 'none';

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            applyAllFilters();
        }

        function clearFilter(column) {
            delete activeFilters[column];

            // ‡∏ã‡πà‡∏≠‡∏ô filter indicator
            const indicator = document.getElementById(`filter-${column}`);
            if (indicator) {
                indicator.style.display = 'none';
            }

            // ‡∏õ‡∏¥‡∏î dropdown
            document.getElementById(`dropdown-${column}`).style.display = 'none';

            // ‡∏Å‡∏£‡∏≠‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
            applyAllFilters();
        }

        function applyAllFilters() {
            filteredBudsData = allBudsData.filter(bud => {
                return Object.entries(activeFilters).every(([column, filterValue]) => {
                    let budValue = bud[column];

                    if (budValue == null || budValue === '') {
                        budValue = '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    } else if (column === 'created_at') {
                        budValue = formatDate(budValue);
                    } else {
                        budValue = String(budValue);
                    }

                    if (filterValue === null) {
                        return budValue === '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
                    }

                    return budValue === filterValue;
                });
            });

            updateSummaryCards();
            displayTable();
        }

        // ‡∏õ‡∏¥‡∏î dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ô‡∏≠‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.data-table')) {
                document.querySelectorAll('.filter-dropdown').forEach(dropdown => {
                    dropdown.style.display = 'none';
                });
            }
        });



        function displayTable() {
            const dataToDisplay = filteredBudsData.length > 0 || Object.keys(activeFilters).length > 0 ? filteredBudsData : allBudsData;
            displayTableWithData(dataToDisplay);
        }

        function getStrainTypeClass(type) {
            switch(type) {
                case 'Indica': return 'type-indica';
                case 'Sativa': return 'type-sativa';
                case 'Hybrid': return 'type-hybrid';
                default: return '';
            }
        }

        function getGradeClass(grade) {
            switch(grade) {
                case 'A+': return 'grade-a-plus';
                case 'A': return 'grade-a';
                case 'B+': return 'grade-b-plus';
                case 'B': return 'grade-b';
                case 'C': return 'grade-c';
                default: return '';
            }
        }

        function formatDate(dateString) {
            if (!dateString) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
            const date = new Date(dateString);
            return date.toLocaleDateString('th-TH', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
        }

        function getStatusClass(status) {
            switch(status) {
                case 'available': return 'status-available';
                case 'sold_out': return 'status-sold-out';
                default: return 'status-available';
            }
        }

        function getStatusText(status) {
            switch(status) {
                case 'available': return '‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
                case 'sold_out': return '‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß';
                default: return '‡∏¢‡∏±‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠';
            }
        }

        function sortTable(column) {
            // Toggle sort direction if clicking the same column
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortDirection = 'asc';
                currentSortColumn = column;
            }

            // Clear all sort indicators
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.className = 'sort-indicator';
            });

            // Set current sort indicator
            const currentIndicator = document.getElementById(`sort-${column}`);
            if (currentIndicator) {
                currentIndicator.className = `sort-indicator sort-${currentSortDirection}`;
            }

            // Sort the data
            const dataToSort = filteredBudsData.length > 0 || Object.keys(activeFilters).length > 0 ? filteredBudsData : allBudsData;
            const sortedData = [...dataToSort].sort((a, b) => {
                let aValue = a[column];
                let bValue = b[column];

                // Handle null/undefined values
                if (aValue == null) aValue = '';
                if (bValue == null) bValue = '';

                // Handle different data types
                if (column === 'id' || column === 'thc_percentage' || column === 'cbd_percentage' || 
                    column === 'avg_rating' || column === 'review_count') {
                    aValue = parseFloat(aValue) || 0;
                    bValue = parseFloat(bValue) || 0;
                } else if (column === 'created_at') {
                    aValue = new Date(aValue || 0);
                    bValue = new Date(bValue || 0);
                } else {
                    aValue = String(aValue).toLowerCase();
                    bValue = String(bValue).toLowerCase();
                }

                // Compare values
                if (aValue < bValue) {
                    return currentSortDirection === 'asc' ? -1 : 1;
                }
                if (aValue > bValue) {
                    return currentSortDirection === 'asc' ? 1 : -1;
                }
                return 0;
            });

            // Update the display with sorted data
            displayTableWithData(sortedData);
        }

        function displayTableWithData(dataToDisplay) {
            const tbody = document.getElementById('tableBody');

            if (dataToDisplay.length === 0) {
                tbody.innerHTML = '<tr><td colspan="12" class="empty-state">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td></tr>';
                return;
            }

            tbody.innerHTML = dataToDisplay.map(bud => `
                <tr>
                    <td>${bud.id}</td>
                    <td class="strain-name">${bud.strain_name_en || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
                    <td>${bud.strain_name_th || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</td>
                    <td>
                        <span class="strain-type ${getStrainTypeClass(bud.strain_type)}">
                            ${bud.strain_type || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                        </span>
                    </td>
                    <td class="thc-cbd-display">
                        <div class="thc">THC: ${bud.thc_percentage || 'N/A'}%</div>
                        <div class="cbd">CBD: ${bud.cbd_percentage || 'N/A'}%</div>
                    </td>
                    <td>
                        <span class="grade-badge ${getGradeClass(bud.grade)}">
                            ${bud.grade || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                        </span>
                    </td>
                    <td>
                        <div class="rating-display">
                            <div class="rating-stars">${'‚≠ê'.repeat(Math.round(bud.avg_rating || 0))}</div>
                            <div class="rating-number">${(bud.avg_rating || 0).toFixed(1)}</div>
                        </div>
                    </td>
                    <td class="review-count">${bud.review_count || 0} ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß</td>
                    <td class="grower-info">
                        <div ${bud.grower_license_verified ? 'class="verified-grower"' : ''}>
                            ${bud.grower_name || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}
                            ${bud.grower_license_verified ? ' ‚úÖ' : ''}
                        </div>
                    </td>
                    <td>
                        <span class="status-badge ${getStatusClass(bud.status)}">
                            ${getStatusText(bud.status)}
                        </span>
                    </td>
                    <td>${formatDate(bud.created_at)}</td>
                    <td>
                        <a href="/bud-report?id=${bud.id}" class="full-report-btn" target="_blank">
                            üìä Full Report
                        </a>
                    </td>
                </tr>
            `).join('');
        }


    </script>
</body>
</html>